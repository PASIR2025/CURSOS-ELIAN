<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mis cursos</title>
  <style>
    body{font-family:system-ui;margin:0;background:#0b1220;color:#f9fafb;min-height:100vh}
    header{padding:14px 16px;border-bottom:1px solid rgba(148,163,184,.25);display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .card{border:1px solid rgba(148,163,184,.25);border-radius:16px;background:rgba(148,163,184,.06);padding:14px}
    .title{font-weight:1000}
    .muted{color:#9ca3af}
    .btn{display:inline-block;padding:10px 12px;border-radius:12px;text-decoration:none;font-weight:900}
    .primary{background:#22c55e;color:#071018;border:0;cursor:pointer}
    .secondary{background:rgba(56,189,248,.18);color:#f9fafb;border:1px solid rgba(56,189,248,.35)}
    .err{color:#fca5a5;font-weight:700;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Mis cursos</div>
      <div class="muted">Aquí verás solo los cursos que están habilitados para tu correo.</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <a class="btn secondary" href="index.html">Volver</a>
      <button id="logout" class="btn primary">Cerrar sesión</button>
    </div>
  </header>

  <div class="wrap">
    <div id="status" class="muted">Cargando…</div>
    <div id="list" class="grid" style="margin-top:12px"></div>
  </div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxDqkSFvg7n7dxRkSk3w0x842bSW3aoODvTVlLoCyM4AJYFOhCmiOpG6ILv6uBlL-kgHg/exec';

  function jsonp(action, payload) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const params = new URLSearchParams();
      params.set("action", action);
      Object.entries(payload || {}).forEach(([k,v]) => {
        if (v === undefined || v === null) return;
        params.set(k, String(v));
      });
      params.set("callback", cb);

      const script = document.createElement("script");
      script.src = API_URL + "?" + params.toString();
      script.async = true;

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      function cleanup() {
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        if (script.parentNode) script.parentNode.removeChild(script);
      }

      script.onerror = () => {
        cleanup();
        reject(new Error("No se pudo conectar (JSONP)."));
      };

      document.body.appendChild(script);
    });
  }

  const token = sessionStorage.getItem("pasir_token");
  if (!token) location.href = "login.html";

  document.getElementById("logout").onclick = () => {
    sessionStorage.removeItem("pasir_token");
    location.href = "index.html";
  };

  (async () => {
    try {
      const r = await jsonp("me", { token });
      if (!r.ok) {
        sessionStorage.removeItem("pasir_token");
        return location.href = "login.html";
      }

      const status = document.getElementById("status");
      const list = document.getElementById("list");

      if (!r.courses || r.courses.length === 0) {
        status.textContent = "Aún no tienes cursos habilitados. Si ya pagaste, espera a que lo active por WhatsApp.";
        list.innerHTML = "";
        return;
      }

      status.textContent = "Cursos habilitados:";
      list.innerHTML = r.courses.map(c => `
        <div class="card">
          <div class="title">${c.title || c.courseId}</div>
          <div class="muted" style="margin:8px 0 12px">ID: ${c.courseId}</div>
          <a class="btn secondary" href="course.html?courseId=${encodeURIComponent(c.courseId)}">Entrar al curso</a>
        </div>
      `).join("");
    } catch (e) {
      document.getElementById("status").innerHTML = '<div class="err">'+(e.message || e)+'</div>';
    }
  })();
</script>
</body>
</html>
